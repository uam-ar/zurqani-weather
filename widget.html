<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campus Weather</title>

  <style>
    :root{
      --card-bg: #f5f4ef;
      --border: rgba(0,0,0,.10);
      --text: #111;
      --muted: rgba(0,0,0,.65);
      --muted2: rgba(0,0,0,.45);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
    }

    html, body { margin:0; padding:0; background: transparent; color: var(--text); font-family: system-ui, Arial, sans-serif; }

    .card{
      width:100%;
      max-width: 860px;
      box-sizing: border-box;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      background: #f5f4ef;
      box-shadow: var(--shadow);
    }

    .header{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .titleWrap{ display:flex; flex-direction: column; gap: 4px; }
    .title{ font-size: 20px; font-weight: 900; letter-spacing: .2px; }
    .subtitle{ font-size: 12px; color: var(--muted); }

    .pill{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.6);
      white-space: nowrap;
      font-weight: 650;
      color: rgba(0,0,0,.75);
    }

    .status{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    .nowRow{
      display:flex;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.55);
    }

    .bigIcon{
      width: 52px;
      height: 52px;
      display:grid;
      place-items:center;
      font-size: 30px;
      border-radius: 14px;
      background: rgba(0,0,0,.04);
      border: 1px solid rgba(0,0,0,.06);
      flex: 0 0 auto;
    }

    .nowMain{ flex: 1 1 auto; min-width: 0; }
    .nowLine{ font-size: 16px; font-weight: 800; line-height: 1.25; margin-bottom: 4px; }
    .nowMeta{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.3;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .todayHint{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(0,0,0,.55);
      font-weight: 650;
    }

    .sparkWrap{
      flex: 0 0 170px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }
    .sparkLabel{ font-size: 12px; color: var(--muted2); font-weight: 700; }
    canvas{ display:block; }

    /* Hourly panel */
    .hourlyPanel{
      margin-top: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,.45);
    }
    .hourlyHdr{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
    }
    .hourlyTitle{
      font-weight: 900;
      font-size: 13px;
    }
    .hourlyNote{
      font-size: 12px;
      color: var(--muted2);
      font-weight: 650;
      white-space: nowrap;
    }
    .hourlyCanvasWrap{
      width: 100%;
      overflow: hidden;
      position: relative;
    }
    #hourlyChart{
      width: 100%;
      height: 120px;
    }

    /* Tooltip (used for hourly + sparkline) */
    .tooltip{
      position: absolute;
      display: none;
      pointer-events: none;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.95);
      box-shadow: 0 10px 24px rgba(0,0,0,.10);
      font-size: 12px;
      font-weight: 750;
      color: #111;
      white-space: nowrap;
      z-index: 10;
    }
    .tooltip .sub{
      display:block;
      margin-top: 2px;
      font-size: 11px;
      font-weight: 650;
      color: rgba(0,0,0,.60);
    }

    .alerts{
      display:none;
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255, 235, 59, 0.18);
    }
    .alerts .hdr{
      font-weight: 900;
      display:flex;
      align-items:center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .alertItem{
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed rgba(0,0,0,.18);
    }
    .alertName{ font-weight: 800; }
    .alertMeta{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .alertDesc{
      font-size: 13px;
      margin-top: 6px;
      line-height: 1.35;
      color: rgba(0,0,0,.85);
    }
    .alertDesc a.toggleAlert{
      font-weight: 900;
      color: #111;
      text-decoration: underline;
      margin-left: 6px;
    }

    .sectionTitle{ font-weight: 900; margin-top: 14px; margin-bottom: 8px; font-size: 14px; }

    table{
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: rgba(255,255,255,.35);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }
    thead th{
      text-align:left;
      font-weight: 800;
      color: rgba(0,0,0,.75);
      background: rgba(0,0,0,.03);
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
    }
    tbody td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      vertical-align: middle;
    }
    tbody tr:last-child td{ border-bottom: none; }
    .r{ text-align:right; }
    .cond{ display:flex; align-items:center; gap: 8px; white-space: nowrap; }
    .cond .sIcon{ font-size: 16px; }

    tbody tr.today{ background: rgba(0,0,0,.04); }
    tbody tr.today td{ font-weight: 700; }

    .footer{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
    }

    .disclaimer{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div id="card" class="card">
    <div class="header">
      <div class="titleWrap">
        <div class="title">Campus Weather</div>
        <div class="subtitle">Model-based conditions & forecast (Open-Meteo)</div>
      </div>
      <div id="locPill" class="pill">Loading‚Ä¶</div>
    </div>

    <div id="status" class="status">Loading‚Ä¶</div>

    <div id="alerts" class="alerts">
      <div class="hdr">üö® Weather Alerts</div>
      <div id="alertsBody"></div>
    </div>

    <div id="nowBlock"></div>
    <div id="hourlyBlock"></div>

    <div class="sectionTitle">7-Day Forecast</div>
    <div id="forecast"></div>

    <div class="footer">
      <div id="updated"></div>
      <div id="source"></div>
    </div>

    <div class="disclaimer">
      Note: Values may differ from consumer weather apps because this widget uses numerical weather model outputs rather than proprietary station-blended nowcasts.
    </div>
  </div>

<script>
(function(){
  var WEATHER_JSON_URL = "./weather.json";

  // Alerts point (keep in sync with fetch_weather.py)
  var ALERT_LAT = 33.6289;
  var ALERT_LON = -91.7909;

  function cToF(c){ return (c * 9 / 5) + 32; }
  function safe(v){ return (v === null || v === undefined) ? "‚Äî" : v; }

  function icon(code){
    if (code === 0) return "‚òÄÔ∏è";
    if (code === 1 || code === 2) return "üå§Ô∏è";
    if (code === 3) return "‚òÅÔ∏è";
    if (code >= 45 && code <= 48) return "üå´Ô∏è";
    if (code >= 51 && code <= 57) return "üå¶Ô∏è";
    if (code >= 61 && code <= 67) return "üåßÔ∏è";
    if (code >= 71 && code <= 77) return "‚ùÑÔ∏è";
    if (code >= 80 && code <= 82) return "üå¶Ô∏è";
    if (code >= 95) return "‚õàÔ∏è";
    return "üå•Ô∏è";
  }

  function label(code){
    if (code === 0) return "Clear";
    if (code === 1 || code === 2) return "Mostly clear";
    if (code === 3) return "Cloudy";
    if (code >= 45 && code <= 48) return "Fog";
    if (code >= 51 && code <= 57) return "Drizzle";
    if (code >= 61 && code <= 67) return "Rain";
    if (code >= 71 && code <= 77) return "Snow";
    if (code >= 80 && code <= 82) return "Showers";
    if (code >= 95) return "Thunderstorm";
    return "Mixed";
  }

  function degToCardinal(deg){
    if (deg == null) return "‚Äî";
    var dirs = ["N","NE","E","SE","S","SW","W","NW"];
    var ix = Math.round(deg / 45) % 8;
    return dirs[ix];
  }

  function fmtTime(s){
    if (!s) return "‚Äî";
    return String(s).replace("T"," ").replace(/\+.*$/,"").replace("Z","");
  }

  function truncate(txt, n){
    txt = txt || "";
    if (txt.length <= n) return txt;
    return txt.slice(0, n - 1) + "‚Ä¶";
  }

  function isoDateInTimeZone(tz){
    try{
      var parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz,
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      }).formatToParts(new Date());

      var y = parts.find(function(p){ return p.type === "year"; }).value;
      var m = parts.find(function(p){ return p.type === "month"; }).value;
      var d = parts.find(function(p){ return p.type === "day"; }).value;
      return y + "-" + m + "-" + d;
    }catch(e){
      var d0 = new Date();
      return d0.getFullYear() + "-" + String(d0.getMonth()+1).padStart(2,"0") + "-" + String(d0.getDate()).padStart(2,"0");
    }
  }

  function hourLabelFromTimeStr(t){
    if (!t || t.indexOf("T") === -1) return "";
    var hh = parseInt(t.split("T")[1].slice(0,2), 10);
    if (isNaN(hh)) return "";
    var ampm = (hh >= 12) ? "p" : "a";
    var h12 = hh % 12; if (h12 === 0) h12 = 12;
    return String(h12) + ampm;
  }

  function parseLocalHourTime(s){
    if (!s) return null;
    return new Date(s);
  }

  function nl2br(s){
    return String(s || "").replace(/\n/g, "<br>");
  }

  // Sparkline w/ points returned for tooltip
  function drawSparkline(canvas, values){
    var ctx = canvas.getContext("2d");
    var w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    if (!values || values.length < 2) return { points: [] };

    var min = Infinity, max = -Infinity;
    values.forEach(function(v){
      if (v == null) return;
      min = Math.min(min, v);
      max = Math.max(max, v);
    });
    if (min === max) { min -= 1; max += 1; }

    function x(i){ return (i/(values.length-1)) * (w-10) + 5; }
    function y(v){ return (h-8) - ((v-min)/(max-min))*(h-16) + 4; }

    ctx.beginPath();
    values.forEach(function(v,i){
      if (v == null) return;
      var px = x(i), py = y(v);
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    });
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.stroke();

    var points = [];
    values.forEach(function(v,i){
      if (v == null) return;
      var px = x(i), py = y(v);
      ctx.beginPath();
      ctx.arc(px, py, 3.5, 0, Math.PI*2);
      ctx.fillStyle = "#111";
      ctx.fill();
      points.push({ i: i, x: px, y: py, v: v });
    });

    return { points: points };
  }

  // Hourly chart: temp line + precip bars + tooltip points return + NOW LINE
  function drawHourly(canvas, tempsF, pops, labels, hourTimes){
    var ctx = canvas.getContext("2d");

    var cssW = canvas.clientWidth || 800;
    var cssH = canvas.clientHeight || 120;
    var dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    var w = cssW, h = cssH;
    ctx.clearRect(0,0,w,h);

    if (!tempsF || tempsF.length < 2) return { points: [] };

    var padL = 28, padR = 10, padT = 10, padB = 22;
    var chartW = w - padL - padR;
    var chartH = h - padT - padB;

    var precipH = Math.floor(chartH * 0.30);
    var tempH = chartH - precipH - 6;

    var tmin = Infinity, tmax = -Infinity;
    tempsF.forEach(function(v){
      if (v == null) return;
      tmin = Math.min(tmin, v);
      tmax = Math.max(tmax, v);
    });
    if (tmin === tmax) { tmin -= 1; tmax += 1; }
    var tPad = 1.5;
    tmin -= tPad; tmax += tPad;

    function x(i){ return padL + (i/(tempsF.length-1)) * chartW; }
    function yTemp(v){
      var tNorm = (v - tmin) / (tmax - tmin);
      return padT + (tempH - (tNorm * tempH));
    }

    // baseline
    ctx.strokeStyle = "rgba(0,0,0,.08)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, padT + tempH);
    ctx.lineTo(padL + chartW, padT + tempH);
    ctx.stroke();

    // NOW LINE
    if (hourTimes && hourTimes.length >= 2){
      var now = new Date();

      var idx = -1;
      for (var i=0; i<hourTimes.length; i++){
        var dt = hourTimes[i];
        if (dt && dt.getTime() >= now.getTime()){
          idx = i;
          break;
        }
      }

      var xNow = null;
      if (idx === 0){
        xNow = x(0);
      } else if (idx > 0){
        var t0 = hourTimes[idx-1].getTime();
        var t1 = hourTimes[idx].getTime();
        var tn = now.getTime();
        var frac = (t1 === t0) ? 0 : (tn - t0) / (t1 - t0);
        frac = Math.max(0, Math.min(1, frac));
        xNow = x(idx-1) + frac * (x(idx) - x(idx-1));
      } else {
        xNow = x(hourTimes.length - 1);
      }

      ctx.save();
      ctx.strokeStyle = "rgba(220, 0, 0, .75)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(xNow, padT);
      ctx.lineTo(xNow, padT + tempH + 6 + precipH);
      ctx.stroke();

      ctx.fillStyle = "rgba(220, 0, 0, .85)";
      ctx.font = "12px system-ui, Arial";
      ctx.textAlign = "center";
      ctx.fillText("Now", xNow, padT + 10);
      ctx.restore();
    }

    // temp line
    ctx.beginPath();
    tempsF.forEach(function(v,i){
      if (v == null) return;
      var px = x(i), py = yTemp(v);
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    });
    ctx.strokeStyle = "#111";
    ctx.lineWidth = 2;
    ctx.stroke();

    // points + store for tooltip
    var points = [];
    tempsF.forEach(function(v,i){
      if (v == null) return;
      var px = x(i), py = yTemp(v);
      ctx.beginPath();
      ctx.arc(px, py, 2.8, 0, Math.PI*2);
      ctx.fillStyle = "#111";
      ctx.fill();
      points.push({ i: i, x: px, y: py, t: v, p: pops[i], label: labels[i] });
    });

    // precip bars
    var baseY = padT + tempH + 6 + precipH;
    ctx.fillStyle = "rgba(0,0,0,.18)";
    for (var k = 0; k < pops.length; k++){
      var p = pops[k];
      if (p == null) continue;
      var barH = (Math.max(0, Math.min(100, p))/100) * precipH;
      var barW = Math.max(2, chartW / pops.length - 2);
      var px2 = x(k) - (barW/2);
      ctx.fillRect(px2, baseY - barH, barW, barH);
    }

    // left labels
    ctx.fillStyle = "rgba(0,0,0,.55)";
    ctx.font = "12px system-ui, Arial";
    ctx.textAlign = "right";
    ctx.fillText(Math.round(tmax) + "¬∞", padL - 6, padT + 10);
    ctx.fillText(Math.round(tmin) + "¬∞", padL - 6, padT + tempH);

    // x labels every 6 hours
    ctx.textAlign = "center";
    ctx.fillStyle = "rgba(0,0,0,.50)";
    for (var j = 0; j < labels.length; j++){
      if (j % 6 !== 0) continue;
      ctx.fillText(labels[j], x(j), h - 6);
    }

    return { points: points };
  }

  // Tooltip helper (auto place above/below + clamp)
  function attachTooltipToCanvas(canvas, tipEl, getStateFn, formatHtmlFn, hitRadius){
    if (!canvas || !tipEl) return;

    function hideTip(){ tipEl.style.display = "none"; }

    function nearestPoint(clientX, clientY){
      var rect = canvas.getBoundingClientRect();
      var x = clientX - rect.left;
      var y = clientY - rect.top;

      var state = getStateFn();
      var pts = (state && state.points) ? state.points : [];

      var best = null;
      var bestD = Infinity;
      var R = hitRadius || 12;

      pts.forEach(function(pt){
        var dx = pt.x - x;
        var dy = pt.y - y;
        var d = Math.sqrt(dx*dx + dy*dy);
        if (d < bestD){ bestD = d; best = pt; }
      });

      if (best && bestD <= R) return best;
      return null;
    }

    function showTip(pt, clientX, clientY){
      tipEl.innerHTML = formatHtmlFn(pt);
      tipEl.style.display = "block";

      var wrap = tipEl.parentElement;
      var wrapRect = wrap.getBoundingClientRect();
      var canvasRect = canvas.getBoundingClientRect();

      var x = clientX - wrapRect.left;
      var y = clientY - wrapRect.top;

      var yInCanvas = clientY - canvasRect.top;
      var placeBelow = (yInCanvas < 28);

      var tw = tipEl.offsetWidth;
      var th = tipEl.offsetHeight;

      var top = placeBelow ? (y + 14) : (y - 14 - th);
      var left = x - (tw / 2);

      var pad = 8;
      if (left < pad) left = pad;
      if (left + tw > wrapRect.width - pad) left = wrapRect.width - pad - tw;

      if (top < pad) top = pad;
      if (top + th > wrapRect.height - pad) top = wrapRect.height - pad - th;

      tipEl.style.left = left + "px";
      tipEl.style.top = top + "px";
    }

    canvas.addEventListener("mousemove", function(e){
      var pt = nearestPoint(e.clientX, e.clientY);
      if (pt) showTip(pt, e.clientX, e.clientY);
      else hideTip();
    });
    canvas.addEventListener("mouseleave", hideTip);

    canvas.addEventListener("touchstart", function(e){
      if (!e.touches || !e.touches[0]) return;
      var t = e.touches[0];
      var pt = nearestPoint(t.clientX, t.clientY);
      if (pt) showTip(pt, t.clientX, t.clientY);
    }, { passive: true });

    canvas.addEventListener("touchmove", function(e){
      if (!e.touches || !e.touches[0]) return;
      var t = e.touches[0];
      var pt = nearestPoint(t.clientX, t.clientY);
      if (pt) showTip(pt, t.clientX, t.clientY);
      else hideTip();
    }, { passive: true });

    canvas.addEventListener("touchend", hideTip, { passive: true });
  }

  // Alert "Show more / Show less"
  function renderAlertDesc(box){
    var full = decodeURIComponent(box.getAttribute("data-full") || "");
    var short = decodeURIComponent(box.getAttribute("data-short") || "");
    var expanded = box.getAttribute("data-expanded") === "1";

    if (expanded){
      box.innerHTML = nl2br(full) + " <a href='#' class='toggleAlert'>Show less</a>";
    } else {
      box.innerHTML = nl2br(short) + " <a href='#' class='toggleAlert'>Show more</a>";
    }
  }

  fetch(WEATHER_JSON_URL, { cache: "no-store" })
    .then(function(r){
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(function(data){
      document.getElementById("status").textContent = "";

      var cur = data.current || {};
      var daily = data.daily || [];
      var hourly = data.hourly || [];
      var meta = data.meta || {};

      document.getElementById("locPill").textContent = meta.place_name || "Location";

      var tz = meta.timezone || "UTC";
      var today = isoDateInTimeZone(tz);
      var todayDaily = daily && daily.length ? daily[0] : null;

      var tC = cur.temperature_c;
      var tF = (tC == null) ? null : cToF(tC);
      var feelsC = cur.feels_like_c;
      var feelsF = (feelsC == null) ? null : cToF(feelsC);

      var windDir = cur.wind_dir_deg;
      var windCard = degToCardinal(windDir);
      var windGust = cur.wind_gust_kmh;

      var todayHintHtml = "";
      if (todayDaily && todayDaily.weather_code != null){
        todayHintHtml = "<div class='todayHint'>Today: " + label(todayDaily.weather_code) + " (daily forecast)</div>";
      }

      var windExtra = "";
      if (windDir != null || windGust != null){
        var dirPart = (windDir == null) ? "‚Äî" : (windCard + " (" + windDir + "¬∞)");
        var gustPart = (windGust == null) ? "‚Äî" : (windGust.toFixed(1) + " km/h");
        windExtra = "<span>Wind dir: <strong>" + dirPart + "</strong></span>" +
                    "<span>Gust: <strong>" + gustPart + "</strong></span>";
      }

      // Daily highs + dates for spark tooltip
      var highsF = daily.slice(0,7).map(function(d){
        return (d.tmax_c==null) ? null : cToF(d.tmax_c);
      });
      var highDates = daily.slice(0,7).map(function(d){ return d.date; });

      var nowHtml =
        "<div class='nowRow'>" +
          "<div class='bigIcon' aria-hidden='true'>" + icon(cur.weather_code) + "</div>" +
          "<div class='nowMain'>" +
            "<div class='nowLine'>Now: " + safe(tF==null?null:tF.toFixed(1)) + "¬∞F" +
              " <span style='color:rgba(0,0,0,.45); font-weight:800;'>(" + safe(tC==null?null:tC.toFixed(1)) + "¬∞C)</span>" +
              " ‚Ä¢ " + label(cur.weather_code) +
            "</div>" +
            "<div class='nowMeta'>" +
              "<span>Humidity: <strong>" + safe(cur.humidity_pct) + "%</strong></span>" +
              "<span>Wind: <strong>" + safe(cur.wind_speed_kmh) + " km/h</strong></span>" +
              "<span>Feels like: <strong>" + safe(feelsF==null?null:feelsF.toFixed(1)) + "¬∞F</strong></span>" +
              windExtra +
            "</div>" +
            todayHintHtml +
          "</div>" +
          "<div class='sparkWrap'>" +
            "<div class='sparkLabel'>Daily highs (¬∞F)</div>" +
            "<div style='position:relative;'>" +
              "<canvas id='spark' width='170' height='42'></canvas>" +
              "<div id='sparkTip' class='tooltip'></div>" +
            "</div>" +
          "</div>" +
        "</div>";

      document.getElementById("nowBlock").innerHTML = nowHtml;

      // Spark tooltip
      var spark = document.getElementById("spark");
      var sparkTip = document.getElementById("sparkTip");
      var sparkState = { points: [] };

      if (spark){
        sparkState = drawSparkline(spark, highsF);
        sparkState.points.forEach(function(pt){ pt.date = highDates[pt.i] || ""; });

        attachTooltipToCanvas(
          spark,
          sparkTip,
          function(){ return sparkState; },
          function(pt){
            return "<span>" + (pt.date ? pt.date + ": " : "") + "High " + Math.round(pt.v) + "¬∞F</span>";
          },
          10
        );
      }

      // Hourly chart + tooltip + NOW line
      if (hourly && hourly.length){
        var tempsFh = hourly.map(function(h){ return (h.temperature_c==null)?null:cToF(h.temperature_c); });
        var pops = hourly.map(function(h){ return h.precip_prob_pct; });
        var labels = hourly.map(function(h){ return hourLabelFromTimeStr(h.time); });
        var hourTimes = hourly.map(function(h){ return parseLocalHourTime(h.time); });

        var hourlyHtml =
          "<div class='hourlyPanel'>" +
            "<div class='hourlyHdr'>" +
              "<div class='hourlyTitle'>Next 24 hours</div>" +
              "<div class='hourlyNote'>Hover a point</div>" +
            "</div>" +
            "<div class='hourlyCanvasWrap'>" +
              "<canvas id='hourlyChart'></canvas>" +
              "<div id='hourlyTip' class='tooltip'></div>" +
            "</div>" +
          "</div>";

        document.getElementById("hourlyBlock").innerHTML = hourlyHtml;

        var hc = document.getElementById("hourlyChart");
        var tip = document.getElementById("hourlyTip");

        var hourlyState = drawHourly(hc, tempsFh, pops, labels, hourTimes);

        attachTooltipToCanvas(
          hc,
          tip,
          function(){ return hourlyState; },
          function(pt){
            return "<span>" + pt.label + ": " + Math.round(pt.t) + "¬∞F</span>" +
                   (pt.p == null ? "" : "<span class='sub'>Precip: " + pt.p + "%</span>");
          },
          12
        );

        setInterval(function(){
          hourlyState = drawHourly(hc, tempsFh, pops, labels, hourTimes);
          tip.style.display = "none";
        }, 60000);

        window.addEventListener("resize", function(){
          hourlyState = drawHourly(hc, tempsFh, pops, labels, hourTimes);
          tip.style.display = "none";
        });
      } else {
        document.getElementById("hourlyBlock").innerHTML = "";
      }

      // Daily table
      var rows = daily.slice(0,7).map(function(d){
        var maxF = (d.tmax_c==null)?null:cToF(d.tmax_c);
        var minF = (d.tmin_c==null)?null:cToF(d.tmin_c);
        var isToday = (d.date === today);

        return "<tr class='" + (isToday ? "today" : "") + "'>" +
          "<td>" + safe(d.date) + "</td>" +
          "<td><div class='cond'><span class='sIcon'>" + icon(d.weather_code) + "</span><span>" + label(d.weather_code) + "</span></div></td>" +
          "<td class='r'>" + safe(maxF==null?null:maxF.toFixed(0)) + " / " + safe(minF==null?null:minF.toFixed(0)) + "¬∞F</td>" +
          "<td class='r'>" + safe(d.precip_prob_pct) + "%</td>" +
        "</tr>";
      }).join("");

      document.getElementById("forecast").innerHTML =
        "<table>" +
          "<thead><tr>" +
            "<th>Date</th><th>Condition</th><th class='r'>High / Low</th><th class='r'>Precip</th>" +
          "</tr></thead>" +
          "<tbody>" + rows + "</tbody>" +
        "</table>";

      document.getElementById("updated").textContent = "Updated (UTC): " + safe(meta.generated_utc);
      document.getElementById("source").textContent = "Source: " + safe(meta.source);

      // Alerts
      var alertsUrl = "https://api.weather.gov/alerts/active?point=" + ALERT_LAT + "," + ALERT_LON;
      return fetch(alertsUrl, {
        headers: {
          "User-Agent": "zurqani-weather (personal site widget)",
          "Accept": "application/geo+json"
        },
        cache: "no-store"
      });
    })
    .then(function(r){
      if (!r || !r.ok) throw new Error("NWS alerts unavailable");
      return r.json();
    })
    .then(function(alertsJson){
      var feats = (alertsJson && alertsJson.features) ? alertsJson.features : [];
      if (!feats.length) return;

      feats = feats.slice(0, 3);

      var html = feats.map(function(f){
        var p = (f && f.properties) ? f.properties : {};
        var headline = p.headline || p.event || "Alert";
        var severity = p.severity || "‚Äî";
        var onset = fmtTime(p.onset);
        var ends = fmtTime(p.ends || p.expires);

        var full = (p.description || p.instruction || "") + "";
        var short = truncate(full, 320);
        var needsMore = full.length > 320;

        var fullEnc = encodeURIComponent(full);
        var shortEnc = encodeURIComponent(short);

        return "<div class='alertItem'>" +
          "<div class='alertName'>‚ö†Ô∏è " + safe(headline) + "</div>" +
          "<div class='alertMeta'>Severity: " + safe(severity) + " ‚Ä¢ Onset: " + safe(onset) + " ‚Ä¢ Ends: " + safe(ends) + "</div>" +
          (full
            ? (needsMore
                ? "<div class='alertDesc' data-full='" + fullEnc + "' data-short='" + shortEnc + "' data-expanded='0'>" +
                    nl2br(short) + " <a href='#' class='toggleAlert'>Show more</a>" +
                  "</div>"
                : "<div class='alertDesc'>" + nl2br(full) + "</div>"
              )
            : ""
          ) +
        "</div>";
      }).join("");

      document.getElementById("alertsBody").innerHTML = html;
      document.getElementById("alerts").style.display = "block";

      // One event listener for all alerts (works even after toggling)
      var container = document.getElementById("alertsBody");
      container.onclick = function(ev){
        var t = ev.target;
        if (!t || !t.classList || !t.classList.contains("toggleAlert")) return;
        ev.preventDefault();

        var box = t.closest(".alertDesc");
        if (!box) return;

        var expanded = box.getAttribute("data-expanded") === "1";
        box.setAttribute("data-expanded", expanded ? "0" : "1");
        renderAlertDesc(box);
      };
    })
    .catch(function(e){
      var status = document.getElementById("status");
      if (status && status.textContent === "") return;
      document.getElementById("status").textContent =
        "Weather unavailable (" + (e && e.message ? e.message : "error") + ").";
    });
})();
</script>
</body>
</html>
